# Нейронна мережа для класифікації раку легень


### Версія Python - 3.6
  

## Крок 1: Підготовка простору та потрібних бібліотек

- #### Заходимо в Anaconda Navigator  
  - Якщо немає - встановлюємо
    - [Anaconda](https://www.anaconda.com/)
    - [Anaconda Navigator](https://anaconda.org/anaconda/anaconda-navigator)
- #### Створюємо нове середовище
- ##### * Якщо у вас є відеокарта Nvidia - можна встановити CUDA для швидшого тренування моделі за її допомогою
  - Оновіть драйвери відеокарти
  - Встановіть [CUDA Toolkit](https://developer.nvidia.com/cuda-toolkit)
    - Будьте уважні: встановлюйте версію яка відповідає вашій версії tensorflow [посилання на перевірку відповідності](https://www.tensorflow.org/install/source#gpu) (у нашому випадку версія tensorflow - 2.6.2 )
  - Якщо все виконано вірно - у наступному кроці ми отримаємо значення  
  
        Num GPUs Available:  1
- #### Встановлюємо та запускаємо Jupyter Notebook та переходимо до наступного кроку

## Крок 2: Підготовка зображень для тренування
- #### Відкриваємо [ShowAndGenerateData.ipynb](/Codes/ShowAndGenerateData.ipynb)  
- #### Запускаємо код
  - Перший блок встановить всі бібліотеки які використовуватимуться в проекті.
  - Другий блок виведе значення кількості наявних відеоадаптерів для роботи
    - Якщо значення - 0 то модель в подальшому тренуватиметься лише за допомогою процесора
  - Не забудьте додати дані в [lidc-data](/Dataset/lidc-data/) у форматі:
    - #### [Файли для тренування можна взяти тут](https://academictorrents.com/details/015f31a94c600256868be155358dc114157507fc)
    - таблиця діагнозів `stage1_labels.csv`
    - папка з пацієнтами `patients` (оригінал - stage1.7z)
  - Даний код конвертує фотографії в [data](/Dataset/data/) в форматі `.npy`

## Крок 3: Тренування моделі
- #### Відкриваємо [Training.ipynb](/Codes/Training.ipynb)  
- #### Перевіряємо конфігурацію:
  - Вибираємо вибірку конвертованих фото та діагнозів з [data](/Dataset/data/)
  - У блоку `classifier.fit`:
    - batch_size - кількість фотографій, які проходять до зміни поведінки нейронів
    - steps_per_epoch - кількість кроків для тренування однієї епохи
      -  рахується за формулою **`довжина trainX / batch_size`**
    - epochs - кількість епох
  - ##### Конфігурація, використана в проекті (з відеокартою):
    - batch_size = 32
    - steps_per_epoch = 100
    - epochs = 250 
- #### Запускаємо код та очікуємо результатів тренування
  - Проміжкові результати завантажаться у [Codes/logs](/Codes/logs/)
  - Кінцевий результат завантжиться у [models](/models/) 

## Як працює готова модель?
- Відкриваємо файл [app.py](/app.py)
- Запускаємо його за допомогою Flask
- Відкриваємо посилання на локальний сервер ( зазвичай [localhost:5000](http://localhost:5000) )
- Натискаємо **`Завантажити фото`** та вибираємо фото для перевірки
- Очікуємо результату прогнозу

### Компоненти:

- [app.py](/app.py)  
    Файл для запуску локального сервера для перевірки прогнозу мережі
- [models](/models/)  
    Папка в якій зберігатимуться подальші моделі ( Зберігається остання модель. Також можна імпортувати найкращі моделі з [Codes/logs](/Codes/logs/) )
- [templates](/templates/)  
    Папка яка містить Html документ для відображення
- [upload](/upload/)  
    Папка яка міститиме фото які завантажуються
- [Codes](/Codes/)  
  Папка з кодом для генерації даних для тренування моделі, а також з кодом для тренування моделі
  - [logs](/Codes/logs/)  
    Папка що містить дані про натреновану модель. В неї зберігатиметься найкращий результат нейромережі у форматі `model-{час запуску тренування}.h5`
  - [ShowAndGenerateData.ipynb](/Codes/ShowAndGenerateData.ipynb)  
    Файл що містить в собі код для показу конвертації фотографій в потрібний нам формат, а також конвертацію фото з [Dataset/lidc-data](/Dataset/lidc-data/) формату `.dcm` в [Dataset/data](/Dataset/data/) двома файлами:
    - `data_set.npy` - файл з конвертованими зображеннями для тренування
    - `labels_set.npy` - файл з конвертованими значеннями (рак діагностований/рак не діагностований)
  - [Training.ipynb](/Codes/Training.ipynb)  
    Файл що містить код моделі для тренування. Бере значення `data_set.npy` та `labels_set.npy` з [Dataset/data](/Dataset/data/), та за допомогою тренує модель, паралельно записуючи значення накращої моделі в [logs](/Codes/logs/), після тренування записує результат в [models](/models/). Формат файлу - `model-{час запуску тренування}.h5`.  
    #### Параметри тренування:
        - learning_rate=0.001
        - batch_size=32
        - steps_per_epoch=100
        - epochs=250
    - Вибірка - 4039 пацієнтів:  
      - 3635 - тренування моделі
      - 404 - тестування моделі
    - Точність натренованої моделі у нашому випадку - 64.85%
  - [Tests.ipynb](/Codes/Tests.ipynb)  
    Файл що містить код для тестування натренованих моделей на різних вибірках
    - Корисно якщо ваша кількість даних велика та ви можете перевіряти модель на інших фото
- [Dataset](/Dataset/)  
  Папка яка містить дані для тренування нейромережі. Містить в собі:  
  - [lidc-data](/Dataset//lidc-data/)  
    Папка що містить дані пацієнтів, потрібних для тренування. Містить:
    - [stage1_labels.csv](/Dataset/lidc-data/stage1_labels.csv)  
        Таблиця діагнозів паціентів: 0 - рак не діагностовано, 1 - рак діагностовано
    - [patients](/Dataset/lidc-data/patients)  
        Папка з окремими пацієнтами у форматі папок, у яких зібрані фотознімки легень у форматі `.dcm`
  - [data](/Dataset/data/)  
    Папка що містить у собі конвертовані файли даних та діагонзів пацієнтів у форматі `.npy`:  
    - [data_set.npy](/Dataset/data/data_set.npy)  
        Набір конвертованих зображень пацієнтів у розмірі 224*224
    - [labels_set.npy](/Dataset/data/labels_set.npy)  
        Набір діагнозів паціентів: 0 - рак не діагностовано, 1 - рак діагностовано
    - [DataCompile.ipynb](/Dataset/data/DataCompile.ipynb)  
        Файл для збірки декількох наборів пацієнтів. Використовується якщо достатньо пам'яті для підтримки вибірок більше 5000.
